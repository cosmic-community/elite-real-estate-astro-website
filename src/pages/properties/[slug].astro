---
import Layout from '../../layouts/Layout.astro';
import { getProperty, getProperties } from '../../lib/cosmic';
import type { Property, ImageObject } from '../../types';

export async function getStaticPaths() {
	const properties = await getProperties();
	return properties.map((property: Property) => ({
		params: { slug: property.slug },
		props: { property }
	}));
}

const { slug } = Astro.params;
const property = await getProperty(slug!);

if (!property) {
	return Astro.redirect('/404');
}

// Fix: Proper variable declarations and destructuring
const { title, metadata } = property;
const price = metadata.price;
const bedrooms = metadata.bedrooms;
const bathrooms = metadata.bathrooms;
const square_feet = metadata.square_feet;
const property_type = metadata.property_type?.value || metadata.property_type;
const status = metadata.property_status?.value || metadata.status;
const description = metadata.description;
const gallery = metadata.gallery || []; // Fix: Use gallery instead of images
const address = metadata.address;
const listing_agent = metadata.listing_agent;
const features = metadata.features || [];

const formattedPrice = new Intl.NumberFormat('en-US', {
	style: 'currency',
	currency: 'USD',
	minimumFractionDigits: 0
}).format(price);

const formattedSquareFeet = square_feet ? new Intl.NumberFormat('en-US').format(square_feet) : null;
---

<Layout title={`${title} - Elite Real Estate`}>
	<main>
		<!-- Property Header -->
		<section class="bg-gradient-to-r from-blue-900 to-blue-700 text-white py-16">
			<div class="max-w-7xl mx-auto px-4">
				<nav class="text-sm mb-6 opacity-90">
					<a href="/" class="hover:text-yellow-400 transition-colors">Home</a>
					<span class="mx-2">/</span>
					<a href="/properties" class="hover:text-yellow-400 transition-colors">Properties</a>
					<span class="mx-2">/</span>
					<span>{title}</span>
				</nav>
				<div class="flex flex-col lg:flex-row lg:items-end lg:justify-between">
					<div>
						<h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4">{title}</h1>
						<p class="text-xl md:text-2xl mb-2 flex items-center">
							<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
							</svg>
							{address}
						</p>
					</div>
					<div class="mt-4 lg:mt-0">
						<div class="text-3xl md:text-4xl font-bold text-yellow-400">{formattedPrice}</div>
						<div class={`inline-block px-4 py-2 rounded-full text-sm font-semibold mt-2 ${
							status === 'For Sale' ? 'bg-green-500 text-white' :
							status === 'Sold' ? 'bg-red-500 text-white' :
							'bg-yellow-500 text-white'
						}`}>
							{status}
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Property Details -->
		<section class="py-12 bg-gray-50">
			<div class="max-w-7xl mx-auto px-4">
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
					<!-- Main Content -->
					<div class="lg:col-span-2">
						<!-- Image Gallery -->
						{gallery && gallery.length > 0 && (
							<div class="mb-12 bg-white rounded-2xl shadow-lg overflow-hidden">
								<div class="relative">
									<img 
										src={`${gallery[0]?.imgix_url}?w=1200&h=800&fit=crop&auto=format,compress`}
										alt={title}
										class="w-full h-96 lg:h-[500px] object-cover"
									/>
									<div class="absolute bottom-4 right-4 bg-black/70 text-white px-3 py-1 rounded-lg text-sm">
										1 / {gallery.length}
									</div>
								</div>
								{gallery.length > 1 && (
									<div class="p-4">
										<div class="grid grid-cols-4 lg:grid-cols-6 gap-3">
											{gallery.slice(1, gallery.length > 6 ? 6 : gallery.length).map((image: ImageObject, index: number) => (
												<div class="relative group cursor-pointer">
													<img 
														src={`${image.imgix_url}?w=200&h=150&fit=crop&auto=format,compress`}
														alt={`${title} - Image ${index + 2}`}
														class="w-full h-20 object-cover rounded-lg transition-transform group-hover:scale-105"
													/>
													{index === 4 && gallery.length > 6 && (
														<div class="absolute inset-0 bg-black/70 rounded-lg flex items-center justify-center">
															<span class="text-white font-semibold">+{gallery.length - 5}</span>
														</div>
													)}
												</div>
											))}
										</div>
									</div>
								)}
							</div>
						)}

						<!-- Property Features Grid -->
						<div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
							<h2 class="text-2xl font-bold text-gray-900 mb-6">Property Details</h2>
							<div class="grid grid-cols-2 md:grid-cols-4 gap-6">
								<div class="text-center p-4 bg-blue-50 rounded-xl">
									<div class="text-3xl font-bold text-blue-900 mb-1">{bedrooms}</div>
									<div class="text-gray-600 font-medium">Bedroom{bedrooms !== 1 ? 's' : ''}</div>
								</div>
								<div class="text-center p-4 bg-blue-50 rounded-xl">
									<div class="text-3xl font-bold text-blue-900 mb-1">{bathrooms}</div>
									<div class="text-gray-600 font-medium">Bathroom{bathrooms !== 1 ? 's' : ''}</div>
								</div>
								<div class="text-center p-4 bg-blue-50 rounded-xl">
									<div class="text-3xl font-bold text-blue-900 mb-1">{formattedSquareFeet || 'N/A'}</div>
									<div class="text-gray-600 font-medium">Sq Ft</div>
								</div>
								<div class="text-center p-4 bg-blue-50 rounded-xl">
									<div class="text-xl font-bold text-blue-900 mb-1">{property_type}</div>
									<div class="text-gray-600 font-medium">Property Type</div>
								</div>
							</div>
						</div>

						<!-- Description -->
						{description && (
							<div class="bg-white rounded-2xl shadow-lg p-8 mb-8">
								<h2 class="text-2xl font-bold text-gray-900 mb-6">About This Property</h2>
								<div class="prose prose-lg max-w-none text-gray-700 leading-relaxed">
									{description}
								</div>
							</div>
						)}

						<!-- Features -->
						{features && features.length > 0 && (
							<div class="bg-white rounded-2xl shadow-lg p-8">
								<h2 class="text-2xl font-bold text-gray-900 mb-6">Property Features</h2>
								<div class="grid grid-cols-2 md:grid-cols-3 gap-4">
									{features.map((feature: string) => (
										<div class="flex items-center p-3 bg-gray-50 rounded-lg">
											<svg class="w-5 h-5 text-green-500 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
											</svg>
											<span class="text-gray-800 font-medium">{feature}</span>
										</div>
									))}
								</div>
							</div>
						)}
					</div>

					<!-- Sidebar -->
					<div class="lg:col-span-1 space-y-6">
						<!-- Price & Status Card -->
						<div class="bg-white rounded-2xl shadow-lg p-6 sticky top-6">
							<div class="text-center mb-6">
								<div class="text-4xl font-bold text-blue-900 mb-3">{formattedPrice}</div>
								<div class={`inline-block px-4 py-2 rounded-full text-sm font-semibold ${
									status === 'For Sale' ? 'bg-green-100 text-green-800' :
									status === 'Sold' ? 'bg-red-100 text-red-800' :
									'bg-yellow-100 text-yellow-800'
								}`}>
									{status}
								</div>
							</div>

							<!-- Quick Stats -->
							<div class="border-t border-gray-200 pt-6 mb-6">
								<div class="grid grid-cols-2 gap-4 text-center">
									<div>
										<div class="text-2xl font-bold text-gray-900">{bedrooms}</div>
										<div class="text-sm text-gray-600">Bedrooms</div>
									</div>
									<div>
										<div class="text-2xl font-bold text-gray-900">{bathrooms}</div>
										<div class="text-sm text-gray-600">Bathrooms</div>
									</div>
								</div>
								{formattedSquareFeet && (
									<div class="mt-4 text-center">
										<div class="text-2xl font-bold text-gray-900">{formattedSquareFeet}</div>
										<div class="text-sm text-gray-600">Square Feet</div>
									</div>
								)}
							</div>

							<!-- Contact Form -->
							<div class="border-t border-gray-200 pt-6">
								<h3 class="text-lg font-bold text-gray-900 mb-4">Interested in this property?</h3>
								<form class="space-y-4">
									<div>
										<input 
											type="text" 
											placeholder="Your Name" 
											class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<input 
											type="email" 
											placeholder="Email Address" 
											class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<input 
											type="tel" 
											placeholder="Phone Number" 
											class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
										/>
									</div>
									<div>
										<textarea 
											placeholder="Message" 
											rows="4" 
											class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
										></textarea>
									</div>
									<button 
										type="submit" 
										class="w-full bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg font-semibold transition duration-300 transform hover:scale-105"
									>
										Request Information
									</button>
								</form>
							</div>
						</div>

						<!-- Agent Information -->
						{listing_agent && (
							<div class="bg-white rounded-2xl shadow-lg p-6">
								<h3 class="text-xl font-bold text-gray-900 mb-4">Your Agent</h3>
								<div class="text-center">
									{listing_agent.metadata?.photo && (
										<img 
											src={`${listing_agent.metadata.photo.imgix_url}?w=200&h=200&fit=crop&auto=format,compress`}
											alt={listing_agent.metadata.full_name}
											class="w-20 h-20 rounded-full object-cover mx-auto mb-4 border-4 border-blue-100"
										/>
									)}
									<div class="font-bold text-lg text-gray-900 mb-1">
										{listing_agent.metadata?.full_name || listing_agent.title}
									</div>
									{listing_agent.metadata?.phone && (
										<div class="text-gray-600 mb-2">
											<a href={`tel:${listing_agent.metadata.phone}`} class="hover:text-blue-600 transition-colors">
												{listing_agent.metadata.phone}
											</a>
										</div>
									)}
									{listing_agent.metadata?.email && (
										<div class="text-gray-600 mb-4">
											<a href={`mailto:${listing_agent.metadata.email}`} class="hover:text-blue-600 transition-colors">
												{listing_agent.metadata.email}
											</a>
										</div>
									)}
									<a 
										href={`/agents/${listing_agent.slug}`}
										class="inline-block bg-blue-900 hover:bg-blue-800 text-white px-6 py-2 rounded-lg font-semibold transition duration-300"
									>
										View Full Profile
									</a>
								</div>
							</div>
						)}
					</div>
				</div>
			</div>
		</section>
	</main>
</Layout>